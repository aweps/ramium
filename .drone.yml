
kind: pipeline
name: master

platform:
  os: linux
  arch: amd64

workspace:
  base: /workspace
  path: src

steps:
- name: build_image
  pull: if-not-exists
  image: docker
  commands:
  - docker login $${REGISTRY_ENDPOINT} --username $${REGISTRY_USERNAME} --password $${REGISTRY_PASSWORD}
  - docker build --rm=true --pull=true -t $${REGISTRY_ENDPOINT}/$${REGISTRY_REPO} -f Dockerfile ./
  - docker tag $${REGISTRY_ENDPOINT}/$${REGISTRY_REPO} $${REGISTRY_ENDPOINT}/$${REGISTRY_REPO}:drone
  - docker push $${REGISTRY_ENDPOINT}/$${REGISTRY_REPO}:drone
  environment:
    REGISTRY_ENDPOINT: registry.hub.docker.com
    REGISTRY_REPO: dockerdig/hello-world
    REGISTRY_USERNAME:
      from_secret: REGISTRY_USERNAME
    REGISTRY_PASSWORD:
      from_secret: REGISTRY_PASSWORD
  volumes:
  - name: docksock
    path: /var/run/docker.sock

volumes:
- name: docksock
  host:
    path: /var/run/docker.sock

trigger:
  branch:
  - master
